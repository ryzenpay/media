apiVersion: apps/v1
kind: Deployment
metadata:
  name: arr-qbit
  namespace: {{ .Release.Namespace }}
  labels:
    app: qbit
spec:
  replicas: 1
  selector:
    matchLabels:
      app: qbit
  template:
    metadata:
      labels:
        app: qbit
    spec:
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: app
                operator: In
                values:
                - arr
            topologyKey: "kubernetes.io/hostname"
      securityContext:
        fsGroup: {{ .Values.pgid }}
    {{ if .Values.qbittorrent.vpn.enabled }}
      initContainers:
      - name: wireguard
        image: qmcgaw/gluetun:latest
        securityContext:
          capabilities:
            add:
              - NET_ADMIN
        restartPolicy: Always
        env:
          - name: VPN_SERVICE_PROVIDER
            value: {{ .Values.qbittorrent.vpn.config.service_provider }}
          - name: VPN_TYPE
            value: {{ .Values.qbittorrent.vpn.config.type }}
          - name: DNS_ADDRESS
            value: {{ .Values.qbittorrent.vpn.config.dns }}
          - name: FIREWALL_INPUT_PORTS
            value: {{ .Values.qbittorrent.config.web_port | quote }}
          - name: WIREGUARD_PRIVATE_KEY
            valueFrom:
              secretKeyRef:
                name: {{ .Values.qbittorrent.vpn.secret.name }}
                key: {{ .Values.qbittorrent.vpn.secret.privateKeySecretKey }}
          - name: WIREGUARD_ADDRESSES
            valueFrom:
              secretKeyRef:
                name: {{ .Values.qbittorrent.vpn.secret.name }}
                key: {{ .Values.qbittorrent.vpn.secret.addressesSecretKey }}
        {{-  if .Values.qbittorrent.vpn.config.city }}
          - name: SERVER_CITIES
            value: {{ .Values.qbittorrent.vpn.config.cities }}
        {{-  end }}
        startupProbe:
          exec:
            command:
            - /gluetun-entrypoint
            - healthcheck
          periodSeconds: 5
          failureThreshold: 10
        livenessProbe:
          exec:
            command:
            - /gluetun-entrypoint
            - healthcheck
          periodSeconds: 5
          timeoutSeconds: 5
          failureThreshold: 3
    {{ end }}
      containers:
      - name: qbittorrent
        image: lscr.io/linuxserver/qbittorrent:latest
        ports:
          - containerPort: {{ .Values.qbittorrent.config.web_port }}
          - containerPort: {{ .Values.qbittorrent.config.torrenting_port }}
        env:
        - name: PUID
          value: {{ .Values.puid | quote }}
        - name: PGID
          value: {{ .Values.pgid | quote }}
        - name: TZ
          value: {{ .Values.timezone | quote }}
        - name: WEBUI_PORT
          value: {{ .Values.qbittorrent.config.web_port | quote }}
        - name: TORRENTING_PORT
          value: {{ .Values.qbittorrent.config.torrenting_port | quote }}
        {{- with .Values.qbittorrent.extraEnv }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        volumeMounts:
        - name: qbit-config
          mountPath: /config
      {{- if .Values.qbittorrent.persistent.enabled }}
        - name: qbit-data
          mountPath: /downloads
      {{- end }}
      {{- if .Values.qbittorrent.config.configMap }}
        - name: qbit-configmap
          mountPath: /config/qBittorrent
      {{- end }}
      {{- if .Values.qbittorrent.lifecycle }}
        lifecycle:
        {{- toYaml .Values.qbittorrent.lifecycle | nindent 10 }}
      {{- end }}
      # {{ if .Values.qbittorrent.livenessProbe }}
      #   livenessProbe:
      #     exec:
      #       command:
      #         - /bin/sh
      #         - -c
      #         - curl -sf http://localhost:{{ .Values.qbittorrent.config.web_port }}/api/v2/transfer/info | grep -Eq '"connection_status":"(connected|disconnected)"'
      #     periodSeconds: 15
      #     failureThreshold: 3
      # {{ end }}
      volumes:
      - name: qbit-config
        persistentVolumeClaim:
          claimName: qbit-config
      {{- if .Values.qbittorrent.persistent.enabled }}
      - name: qbit-data
        persistentVolumeClaim:
          claimName: qbit-data
      {{- end }}
      {{- if .Values.qbittorrent.config.configMap }}
      - name: qbit-configmap
        configMap:
          name: qbit-config
      {{- end }}